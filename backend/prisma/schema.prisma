
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
        
enum UserRole {
  system_owner
  super_admin
  admin
  it_person
  user
}

enum BusinessType {
  small_business
  medium_business
  large_business
}

enum TicketStatus {
  pending
  solved
}

enum ITDepartment {
  it_operations
  it_qcs
}

enum UserDepartment {
  qa
  qc
  production
  microbiology
  hse
  engineering
  marketing
  accounts
  validation
  ppic
  warehouse
  development
}

enum Location {
  tongi
  salna
  mirpur
  mawna
  rupganj
}

model User {
  id            Int      @id @default(autoincrement())
  username      String      @unique
  email         String      @unique
  password      String
  role          UserRole
  isActive      Boolean     @default(true)
  
  // Relationships
  createdById   Int?
  createdBy     User?       @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers  User[]      @relation("UserCreatedBy")
  
  // Hierarchy tracking fields - to track who created whom in the role hierarchy
  systemOwnerId    Int?
  systemOwner      User?     @relation("SystemOwnerHierarchy", fields: [systemOwnerId], references: [id])
  systemOwnerUsers User[]    @relation("SystemOwnerHierarchy")
  
  superAdminId     Int?
  superAdmin       User?     @relation("SuperAdminHierarchy", fields: [superAdminId], references: [id])
  superAdminUsers  User[]    @relation("SuperAdminHierarchy")
  
  adminId          Int?
  admin            User?     @relation("AdminHierarchy", fields: [adminId], references: [id])
  adminUsers       User[]    @relation("AdminHierarchy")
  
  itPersonId       Int?
  itPerson         User?     @relation("ItPersonHierarchy", fields: [itPersonId], references: [id])
  itPersonUsers    User[]    @relation("ItPersonHierarchy")
  
  // Super Admin specific fields
  businessType  BusinessType?
  accountLimit  Int?
  expiryDate    DateTime?
  
  // New department and location fields
  department    ITDepartment?     // For super_admin, admin, it_person
  locations     Location[]        // Multiple locations for super_admin, single for others
  userLocation  Location?         // Single location inheritance for normal users
  
  // Tickets
  createdTickets Ticket[]   @relation("TicketCreatedBy")
  solvedTickets  Ticket[]   @relation("TicketSolvedBy")
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("users")
}

model Ticket {
  id            Int         @id @default(autoincrement())
  description   String
  status        TicketStatus  @default(pending)
  notes         String?       // Notes added when closing ticket
  
  // Device and contact information (required)
  ip_address    String?        // Required: Only valid IP, not alternative format
  device_name   String?        // Required: Device name
  ip_number     String?    // IP number (alternative IP field)
  
  // Department information (required)
  department    ITDepartment @default(it_operations)  // Required: IT Operations or IT QCS
  user_department UserDepartment? // Optional: User's department for display/filtering
  location      Location?      // Required: Location for filtering
  
  // Relationships
  createdById   Int
  createdBy     User          @relation("TicketCreatedBy", fields: [createdById], references: [id])
  
  // Solver tracking - who solved/closed the ticket
  solvedById    Int?
  solvedBy      User?         @relation("TicketSolvedBy", fields: [solvedById], references: [id])
  solvedAt      DateTime?     // When the ticket was solved
  
  // Attachments
  attachments   Attachment[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("tickets")
}

model Attachment {
  id          Int   @id @default(autoincrement())
  name        String   // Display name for the attachment
  url         String   // URL/link to the attachment
  fileType    String?  // Optional file type (e.g., "pdf", "image", "document")
  
  // Relationships
  ticketId    Int
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@map("attachments")
}

// Archive models for data older than 6 months
model ArchivedTicket {
  id            Int        @id
  description   String
  status        TicketStatus
  notes         String?
  
  // Device and contact information
  ip_address    String        // Required: Only valid IP format
  device_name   String        // Required: Device name
  ip_number     String        // Required: IP number field
  
  // Department information
  department    ITDepartment  // Required: IT Operations or IT QCS
  user_department UserDepartment? // Optional: User's department for display/filtering
  location      Location?      // Required: Location for filtering
  
  createdById   Int
  
  // Solver tracking for archived tickets
  solvedById    Int?
  solvedAt      DateTime?
  
  createdAt     DateTime
  updatedAt     DateTime
  archivedAt    DateTime      @default(now())
  
  attachments   ArchivedAttachment[]
  
  @@map("archived_tickets")
}

model ArchivedAttachment {
  id             Int         @id
  name           String         // Display name for the attachment
  url            String         // URL/link to the attachment
  fileType       String?        // Optional file type (e.g., "pdf", "image", "document")
  ticketId       Int
  ticket         ArchivedTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdAt      DateTime
  archivedAt     DateTime       @default(now())
  
  @@map("archived_attachments")
} 